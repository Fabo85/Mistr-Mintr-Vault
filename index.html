<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIDOLON_VAULT.v3.4.1 // Static Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --bg-deep: #050507;
            --cyan-glow: #00f2ff;
            --ritual-indigo: #6366f1;
            --mint-highlight: #00ffaa;
        }

        body {
            background-color: var(--bg-deep);
            color: #a5f3fc;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            background-image: radial-gradient(circle at 50% 50%, #0a0a0f 0%, #000 100%);
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(13, 13, 18, 0.8);
            border: 1px solid rgba(0, 242, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .reading-glow {
            border-color: var(--mint-highlight) !important;
            box-shadow: 0 0 25px rgba(0, 255, 170, 0.15);
            background: rgba(0, 255, 170, 0.04) !important;
        }

        .media-container {
            background: black;
            border: 1px solid rgba(0, 242, 255, 0.05);
            margin-top: 1rem;
            position: relative;
            overflow: hidden;
        }

        input[type="range"] { 
            accent-color: var(--mint-highlight); 
            height: 4px;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--mint-highlight); }

        .tts-word { transition: color 0.2s; }
        .tts-active-word {
            color: var(--mint-highlight);
            text-shadow: 0 0 12px var(--mint-highlight);
            background: rgba(0, 255, 170, 0.15);
            padding: 0 2px;
            border-radius: 2px;
        }

        @keyframes pulse-mint {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        .mint-pulse { animation: pulse-mint 2s infinite; }
        
        #importInput { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto pb-32">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 border-b border-cyan-900/20 pb-8">
            <div>
                <h1 class="text-3xl font-black tracking-tighter text-white flex items-center gap-3">
                    <span class="text-emerald-400">MISTR_MINTR</span>
                    <span class="text-cyan-900 text-sm font-mono tracking-normal self-end mb-1">// VAULT_3.4.1_STATIC</span>
                </h1>
                <p class="text-[10px] uppercase tracking-[0.3em] text-cyan-800 mt-1">Local Storage Protocol // Offline Archive Enabled</p>
            </div>

            <div class="flex flex-wrap gap-4 items-center bg-black/40 p-4 rounded-sm border border-white/5 backdrop-blur-md">
                <div class="flex items-center gap-3 px-3 border-r border-white/10">
                    <label class="text-[9px] uppercase text-cyan-700 font-bold">Neural Rate</label>
                    <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1.0" class="w-20">
                </div>
                <button onclick="toggleModal(true)" class="bg-emerald-600 text-black px-6 py-2 text-xs font-black uppercase hover:bg-white transition-all shadow-[0_0_15px_rgba(16,185,129,0.2)]">
                    + Link Node
                </button>
            </div>
        </header>

        <!-- Search & Portability Utility Bar -->
        <div class="mb-8 max-w-4xl flex flex-wrap gap-4">
            <div class="flex items-center gap-4 bg-black/60 border border-cyan-900/30 p-4 focus-within:border-emerald-500 transition-all flex-grow">
                <i class="fas fa-fingerprint text-emerald-900"></i>
                <input type="text" id="searchInput" placeholder="FILTER ARCHIVE..." class="bg-transparent w-full outline-none text-emerald-400 placeholder:text-cyan-900 uppercase text-xs font-bold tracking-widest" oninput="renderVault()">
            </div>
            
            <div class="flex gap-2">
                <button onclick="exportData()" title="Backup Vault (JSON Export)" class="p-4 border border-cyan-900/30 text-cyan-700 hover:text-emerald-400 hover:border-emerald-500/50 transition-all">
                    <i class="fas fa-download"></i>
                </button>
                <button onclick="triggerImport()" title="Restore Vault (JSON Import)" class="p-4 border border-cyan-900/30 text-cyan-700 hover:text-ritual-indigo hover:border-ritual-indigo/50 transition-all">
                    <i class="fas fa-upload"></i>
                </button>
                <input type="file" id="importInput" accept=".json" onchange="handleImport(event)">
                <button onclick="clearVault()" title="Purge Local Cache" class="p-4 border border-cyan-900/30 text-cyan-900 hover:text-red-600 hover:border-red-600/50 transition-all">
                    <i class="fas fa-trash-can"></i>
                </button>
            </div>
        </div>

        <div id="vaultGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- HUD (Heads Up Display) -->
    <div id="audioHUD" class="fixed bottom-8 left-1/2 -translate-x-1/2 hidden z-[100] bg-[#08080c]/95 border border-emerald-500/50 py-4 px-8 flex flex-col md:flex-row items-center gap-6 shadow-[0_0_50px_rgba(0,0,0,0.8)] backdrop-blur-2xl rounded-sm min-w-[320px] md:min-w-[750px]">
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div id="hudPulse" class="w-2 h-2 bg-emerald-400 rounded-full"></div>
            <div class="flex flex-col min-w-[140px]">
                <span id="hudStatus" class="text-[10px] font-black uppercase tracking-widest text-emerald-400 leading-none">Cognitive Link</span>
                <span id="hudTime" class="text-[9px] font-mono text-cyan-700 mt-1 tracking-tighter">00:00 / 00:00</span>
            </div>
        </div>
        
        <input type="range" id="hudSeek" min="0" max="100" value="0" class="flex-grow cursor-pointer w-full">

        <div class="flex items-center gap-6">
            <button id="hudPlayPause" class="text-emerald-400 hover:text-white transition-colors text-lg w-8" title="Toggle Playback"><i class="fas fa-play"></i></button>
            <button id="hudStop" class="text-red-900 hover:text-red-500 transition-colors text-lg" title="Terminate Link"><i class="fas fa-power-off"></i></button>
        </div>
    </div>

    <!-- MODAL (Create/Edit Node) -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/98 backdrop-blur-3xl hidden z-[100] flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-[#0d0d12] border border-emerald-500/20 p-8">
            <h2 id="modalTitle" class="text-lg font-black text-emerald-400 mb-8 uppercase tracking-[0.2em]">Node Calibration</h2>
            <div class="space-y-6">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-2 gap-4">
                    <input id="fragmentTitle" placeholder="Node Alias" class="bg-black border border-white/10 p-4 text-emerald-400 outline-none text-sm font-bold tracking-widest">
                    <select id="fileType" class="bg-black border border-white/10 p-4 text-emerald-400 outline-none text-xs uppercase font-bold">
                        <option value="text">Neural Text</option>
                        <option value="audio">Audio Wave</option>
                        <option value="link">Visual (YT)</option>
                    </select>
                </div>
                <input id="fileUrl" placeholder="Source URL (Optional)" class="w-full bg-black border border-white/10 p-4 text-cyan-400 outline-none text-xs font-mono">
                <textarea id="fragmentContent" rows="6" placeholder="Neural Payload Data..." class="w-full bg-black border border-white/10 p-4 text-cyan-100 font-mono text-xs outline-none resize-none"></textarea>
                <div class="flex justify-end gap-6 pt-4">
                    <button onclick="toggleModal(false)" class="text-[10px] text-cyan-900 uppercase font-black tracking-widest hover:text-white transition-colors">Discard</button>
                    <button onclick="handleSave()" class="bg-emerald-600 text-black px-10 py-3 text-xs font-black uppercase shadow-lg shadow-emerald-900/20">Commit to Vault</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --------------------
        // STORAGE MANAGER
        // --------------------
        const StorageManager = {
            KEY: 'EIDOLON_VAULT_DATA',
            get: function() {
                const data = localStorage.getItem(this.KEY);
                return data ? JSON.parse(data) : [];
            },
            save: function(fragments) {
                localStorage.setItem(this.KEY, JSON.stringify(fragments));
            }
        };

        let fragments = StorageManager.get();

        // --------------------
        // MEDIA MANAGER
        // --------------------
        const MediaManager = {
            currentId: null,
            type: null,          
            audio: null,
            yt: null,
            ttsWords: [],
            ttsIndex: 0,
            ttsPlaying: false,
            ttsUtterance: null,
            syncRaf: null,

            dom: {
                pulse: document.getElementById('hudPulse'),
                playPause: document.getElementById('hudPlayPause'),
                seek: document.getElementById('hudSeek'),
                time: document.getElementById('hudTime'),
                status: document.getElementById('hudStatus'),
                container: document.getElementById('audioHUD')
            },

            init: function(item) {
                if (!item) return;
                this.stopAll();
                this.currentId = item.id;
                
                const card = document.getElementById(`card-${item.id}`);
                if (card) card.classList.add('reading-glow');
                this.dom.container.classList.remove('hidden');

                if (item.fileType === 'audio' && item.fileUrl) {
                    this.type = 'audio';
                    this.audio = card.querySelector('audio');
                    this.audio.play().catch(() => {
                        this.dom.status.innerText = 'AUDIO BLOCKED - TAP PLAY';
                        this.updatePlayPauseIcon(false);
                    });
                    this.audio.ontimeupdate = () => this.syncHUD();
                    this.audio.onended = () => this.stopAll();
                    this.dom.status.innerText = 'Audio Waveform';
                    this.updatePlayPauseIcon(true);
                } else if (item.fileType === 'link' && item.fileUrl.includes('youtube')) {
                    this.type = 'yt';
                    const vidId = this.extractYTID(item.fileUrl);
                    this.dom.status.innerText = 'Loading Visuals...';
                    this.yt = new YT.Player(`yt-${item.id}`, {
                        videoId: vidId,
                        playerVars: { autoplay: 1, controls: 0, modestbranding: 1, enablejsapi: 1, rel: 0 },
                        events: {
                            onReady: () => {
                                this.dom.status.innerText = 'Visual Stream';
                                this.startSyncLoop();
                                this.updatePlayPauseIcon(true);
                            },
                            onStateChange: (e) => {
                                if (e.data === YT.PlayerState.ENDED) this.stopAll();
                                this.updatePlayPauseIcon(e.data === YT.PlayerState.PLAYING);
                            }
                        }
                    });
                } else { 
                    this.type = 'tts';
                    this.dom.status.innerText = 'Neural Text Bridge';
                    this.prepareTTSRender(item.id, item.content || "[EMPTY NODE]");
                    this.runTTS(0);
                }
            },

            prepareTTSRender: function(id, content) {
                const el = document.getElementById(`content-${id}`);
                if (!el) return;
                this.ttsWords = content.split(/\s+/);
                el.innerHTML = this.ttsWords.map((w, i) => `<span class="tts-word" id="word-${id}-${i}">${w}</span>`).join(' ');
            },

            runTTS: function(startIndex = 0) {
                this.stopTTSOnly();
                this.ttsIndex = startIndex;
                this.ttsPlaying = true;
                this.updatePlayPauseIcon(true);
                this.speakNextWord();
            },

            speakNextWord: function() {
                if (!this.ttsPlaying || this.ttsIndex >= this.ttsWords.length) {
                    if (this.ttsIndex >= this.ttsWords.length) this.stopAll();
                    return;
                }
                if (this.ttsUtterance) {
                    this.ttsUtterance.onend = null;
                }
                this.ttsUtterance = new SpeechSynthesisUtterance(this.ttsWords[this.ttsIndex]);
                this.ttsUtterance.rate = parseFloat(document.getElementById('rateSlider').value);
                this.ttsUtterance.onend = () => {
                    this.ttsIndex++;
                    this.syncHUD();
                    this.speakNextWord();
                };
                speechSynthesis.speak(this.ttsUtterance);
                this.highlightTTSWord();
            },

            highlightTTSWord: function() {
                const id = this.currentId;
                const old = document.querySelector('.tts-active-word');
                if (old) old.classList.remove('tts-active-word');
                const current = document.getElementById(`word-${id}-${this.ttsIndex}`);
                if (current) {
                    current.classList.add('tts-active-word');
                    current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            },

            stopTTSOnly: function() {
                this.ttsPlaying = false;
                speechSynthesis.cancel();
            },

            startSyncLoop: function() {
                const update = () => {
                    if (this.type !== 'yt' || !this.yt) return;
                    this.syncHUD();
                    this.syncRaf = requestAnimationFrame(update);
                };
                this.syncRaf = requestAnimationFrame(update);
            },

            syncHUD: function() {
                let curr = 0, total = 0;
                if (this.type === 'audio' && this.audio) {
                    curr = this.audio.currentTime;
                    total = this.audio.duration;
                } else if (this.type === 'yt' && this.yt?.getDuration) {
                    curr = this.yt.getCurrentTime();
                    total = this.yt.getDuration();
                } else if (this.type === 'tts') {
                    curr = this.ttsIndex;
                    total = this.ttsWords.length;
                }

                if (total) {
                    const pct = (curr / total) * 100;
                    this.dom.seek.value = pct;
                    this.dom.time.innerText = (this.type === 'tts') 
                        ? `${curr} / ${total} WORDS`
                        : `${this.formatTime(curr)} / ${this.formatTime(total)}`;
                }
            },

            togglePlayPause: function() {
                if (this.type === 'tts') {
                    if (speechSynthesis.speaking && !speechSynthesis.paused) {
                        speechSynthesis.pause();
                        this.ttsPlaying = false;
                        this.updatePlayPauseIcon(false);
                    } else if (speechSynthesis.paused) {
                        speechSynthesis.resume();
                        this.ttsPlaying = true;
                        this.updatePlayPauseIcon(true);
                    } else {
                        this.runTTS(this.ttsIndex);
                    }
                } else if (this.type === 'audio' && this.audio) {
                    if (this.audio.paused) { this.audio.play(); this.updatePlayPauseIcon(true); }
                    else { this.audio.pause(); this.updatePlayPauseIcon(false); }
                } else if (this.type === 'yt' && this.yt) {
                    if (this.yt.getPlayerState() === YT.PlayerState.PLAYING) this.yt.pauseVideo();
                    else this.yt.playVideo();
                }
            },

            seek: function(val) {
                const pct = val / 100;
                if (this.type === 'audio' && this.audio) {
                    this.audio.currentTime = (this.audio.duration || 0) * pct;
                } else if (this.type === 'yt' && this.yt?.getDuration) {
                    this.yt.seekTo(this.yt.getDuration() * pct, true);
                } else if (this.type === 'tts') {
                    this.runTTS(Math.floor(this.ttsWords.length * pct));
                }
            },

            stopAll: function() {
                cancelAnimationFrame(this.syncRaf);
                this.stopTTSOnly();
                if (this.audio) { this.audio.pause(); this.audio.currentTime = 0; this.audio = null; }
                if (this.yt) { try { if(this.yt.destroy) this.yt.destroy(); } catch (e) {} this.yt = null; }
                if (this.currentId) {
                    const card = document.getElementById(`card-${this.currentId}`);
                    if(card) card.classList.remove('reading-glow');
                }
                this.currentId = null;
                this.type = null;
                this.dom.container.classList.add('hidden');
                renderVault();
            },

            updatePlayPauseIcon: function(playing) {
                this.dom.playPause.innerHTML = `<i class="fas fa-${playing ? 'pause' : 'play'}"></i>`;
                this.dom.pulse.classList.toggle('mint-pulse', playing);
            },

            formatTime: (s) => {
                if (isNaN(s) || s < 0) return "00:00";
                const m = Math.floor(s / 60);
                const rs = Math.floor(s % 60);
                return `${m.toString().padStart(2, '0')}:${rs.toString().padStart(2, '0')}`;
            },
            
            extractYTID: (url) => {
                const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
                return (m && m[2].length === 11) ? m[2] : null;
            }
        };

        // --------------------
        // UI CORE
        // --------------------
        window.renderVault = () => {
            const grid = document.getElementById('vaultGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = fragments.filter(f => f.title.toLowerCase().includes(search));

            grid.innerHTML = filtered.map(item => `
                <div id="card-${item.id}" class="glass-card p-6 group flex flex-col h-full ${MediaManager.currentId === item.id ? 'reading-glow' : ''}">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex flex-col">
                            <span class="text-[8px] text-emerald-900 font-black mb-1">NODE_ID: ${item.id.substring(0,8)}</span>
                            <h3 class="text-xs font-black text-emerald-400 uppercase tracking-[0.15em] truncate max-w-[180px]">${item.title}</h3>
                        </div>
                        <div class="flex gap-4 opacity-20 group-hover:opacity-100 transition-opacity">
                            <button onclick="prepareEdit('${item.id}')" class="text-cyan-600 hover:text-emerald-400"><i class="fas fa-sliders"></i></button>
                            <button onclick="deleteFragment('${item.id}')" class="text-cyan-900 hover:text-red-500"><i class="fas fa-circle-xmark"></i></button>
                        </div>
                    </div>

                    <div id="content-${item.id}" class="text-[11px] font-mono text-cyan-200/50 mb-6 flex-grow line-clamp-4 overflow-y-auto max-h-[120px] leading-relaxed">
                        ${item.content || 'NO_PAYLOAD_DETECTED'}
                    </div>

                    ${renderPreviewArea(item)}

                    <button onclick="initializeMedia('${item.id}')" class="mt-6 w-full bg-emerald-500/5 hover:bg-emerald-400 hover:text-black py-3 border border-emerald-500/20 text-[9px] font-black uppercase tracking-widest transition-all">
                        Synchronize Link
                    </button>
                </div>
            `).join('');
        };

        function renderPreviewArea(item) {
            if (item.fileType === 'audio' && item.fileUrl) {
                return `<div class="media-container"><audio class="hidden"><source src="${item.fileUrl}"></audio><div class="h-1 w-full bg-emerald-500/10"></div></div>`;
            }
            if (item.fileType === 'link' && item.fileUrl.includes('youtube')) {
                return `<div class="media-container aspect-video rounded-sm overflow-hidden"><div id="yt-${item.id}" class="w-full h-full bg-black/80"></div></div>`;
            }
            return '';
        }

        window.initializeMedia = (id) => {
            const item = fragments.find(f => f.id === id);
            MediaManager.init(item);
        };

        window.toggleModal = (s) => {
            document.getElementById('modalOverlay').classList.toggle('hidden', !s);
            if(!s) {
                document.getElementById('editId').value = "";
                document.getElementById('fragmentTitle').value = "";
                document.getElementById('fragmentContent').value = "";
                document.getElementById('fileUrl').value = "";
            }
        };

        window.prepareEdit = (id) => {
            const item = fragments.find(f => f.id === id);
            document.getElementById('editId').value = id;
            document.getElementById('fragmentTitle').value = item.title;
            document.getElementById('fileType').value = item.fileType;
            document.getElementById('fileUrl').value = item.fileUrl || "";
            document.getElementById('fragmentContent').value = item.content || "";
            toggleModal(true);
        };

        window.handleSave = () => {
            const id = document.getElementById('editId').value;
            const data = {
                id: id || crypto.randomUUID(),
                title: document.getElementById('fragmentTitle').value || "UNTITLED_NODE",
                fileType: document.getElementById('fileType').value,
                fileUrl: document.getElementById('fileUrl').value,
                content: document.getElementById('fragmentContent').value,
                updatedAt: Date.now()
            };

            if(id) {
                const idx = fragments.findIndex(f => f.id === id);
                fragments[idx] = data;
            } else {
                fragments.unshift(data);
            }

            StorageManager.save(fragments);
            renderVault();
            toggleModal(false);
        };

        window.deleteFragment = (id) => {
            if(confirm("TERMINATE NODE DATA?")) {
                fragments = fragments.filter(f => f.id !== id);
                StorageManager.save(fragments);
                renderVault();
            }
        };

        // --------------------
        // DATA PORTABILITY
        // --------------------
        window.exportData = () => {
            const blob = new Blob([JSON.stringify(fragments, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `EIDOLON_VAULT_BACKUP_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.triggerImport = () => {
            document.getElementById('importInput').click();
        };

        window.handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        if (confirm(`RESTORE ${importedData.length} NODES? THIS WILL OVERWRITE CURRENT LOCAL CACHE.`)) {
                            fragments = importedData;
                            StorageManager.save(fragments);
                            renderVault();
                        }
                    } else { alert("INVALID_SIGNAL: ARCHIVE FORMAT UNRECOGNIZED."); }
                } catch (err) { alert("DECRYPTION_FAILED: NON-JSON PAYLOAD."); }
            };
            reader.readAsText(file);
            event.target.value = '';
        };

        window.clearVault = () => {
            if (confirm("PURGE ENTIRE LOCAL VAULT? THIS CANNOT BE UNDONE WITHOUT A BACKUP.")) {
                fragments = [];
                StorageManager.save(fragments);
                renderVault();
            }
        };

        // Setup HUD controls
        document.getElementById('hudPlayPause').onclick = () => MediaManager.togglePlayPause();
        document.getElementById('hudStop').onclick = () => MediaManager.stopAll();
        document.getElementById('hudSeek').oninput = (e) => MediaManager.seek(e.target.value);

        // Run
        renderVault();
    </script>
</body>
</html>

